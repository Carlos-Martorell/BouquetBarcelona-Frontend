
<section class="container mx-auto p-6">

  <header class="mb-8 flex items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-primary">GestiÃ³n de Pedidos</h1>
      <p class="text-text/70">Total: {{ orderCount() }} pedidos</p>
    </div>
    
    <button 
      (click)="openCreateModal()"
      class="btn-primary px-6 py-3">
      + Nuevo Pedido
    </button>
  </header>

  <div id="filtros" class="mb-6 flex flex-col md:flex-row gap-4">
  
    <input 
      type="text"
      placeholder="Buscar por nombre, email o direcciÃ³n..."
      [value]="searchQuery()"
      (input)="searchQuery.set($any($event.target).value)"
      class="flex-1 px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
    
    <select 
      [value]="selectedStatus()"
      (change)="selectedStatus.set($any($event.target).value)"
      class="px-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
      <option value="all">Todos los estados</option>
      <option value="pending">Pendientes</option>
      <option value="confirmed">Confirmados</option>
      <option value="delivered">Entregados</option>
      <option value="cancelled">Cancelados</option>
    </select>
  </div>

  @if (isLoading()) {
    <div class="text-center py-12">
      <div class="spinner mx-auto animate-[spin_2s_linear_infinite]"></div>
      <p class="text-text mt-4">Cargando pedidos...</p>
    </div>
  }

  @if (errorMessage()) {
    <div class="bg-error/10 border border-error p-6 rounded-lg flex-1 text-center">
        <span class="text-text text-2xl">âš ï¸</span>
        <p class="font-bold text-text/80 mb-1">Oh, algo ha fallado...</p>
        <p class="text-text mb-3">{{ errorMessage() }}</p>
        <button 
            (click)="loadOrders()"
            class="mt-3 btn-secondary bg-error">
            Reintentar
        </button>
    </div>
  }

  @if (!isLoading() && !errorMessage()) {
    @if (filteredOrders().length === 0) {
      <div class="text-center py-16 bg-background rounded-lg border border-border">
        <span class="text-6xl mb-4 block">ğŸ“¦</span>
        <p class="text-text text-lg">No hay pedidos que mostrar</p>
      </div>
    } @else {
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @for (order of filteredOrders(); track order._id) {
          <article class="bg-white border border-border rounded-lg p-5 shadow-sm hover:shadow-md transition-shadow">
            
            <!-- Header del pedido -->
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="text-xl font-bold text-primary">{{ order.customerName }}</h3>
                <p class="text-sm text-text/70">{{ order.customerPhone }}</p>
                <p class="text-sm text-text/70">{{ order.customerEmail }}</p>
              </div>
              
              <!-- Estado -->
              <span 
                class="px-3 py-1 rounded-full text-sm font-semibold"
                [class]="getStatusColor(order.status)">
                {{ getStatusLabel(order.status) }}
              </span>
            </div>

            <!-- Detalles de entrega -->
            <div class="mb-4 space-y-2">
                <p class="text-sm">
                    <span class="font-semibold">ğŸ“ DirecciÃ³n:</span> {{ order.deliveryAddress }}
                    @if (order.deliveryDetails) {
                      <span class="text-text/70"> - {{ order.deliveryDetails }}</span>
                    }
                </p>
                <p class="text-sm ml-6">
                    @if(order.coordinates){
                        <p class="text-text/50">Coordenadas OK: {{ order.coordinates.lng }} - {{ order.coordinates.lat }} </p>
                    } @else {<p class="text-error/80">Sin coordenadas, precauciÃ³n en el mapa.</p>}
                </p>
              <p class="text-sm">
                <span class="font-semibold">ğŸ“… Fecha:</span> {{ order.deliveryDate | date:'dd/MM/yyyy' }}
              </p>

              <p class="text-sm">
                <span class="font-semibold">ğŸ• Hora:</span> {{ order.deliveryTime }}
              </p>
            </div>

            <!-- Items del pedido -->
            <div class="mb-4">
              <p class="font-semibold text-sm mb-2">ğŸŒ¸ Productos:</p>
              <ul class="space-y-1">
                @for (item of order.items; track item.flowerId) {
                  <li class="text-sm text-text/80">
                    â€¢ {{ item.flowerName }} x{{ item.quantity }} - {{ item.price }}â‚¬
                  </li>
                }
              </ul>
            </div>

            <!-- Total y notas -->
            <div class="mb-4 pt-3 border-t border-border">
              <p class="text-lg font-bold text-primary">Total: {{ order.total }}â‚¬</p>
              @if (order.notes) {
                <p class="text-sm text-text/70 mt-2">
                  <span class="font-semibold">ğŸ“ Notas:</span> {{ order.notes }}
                </p>
              } @else {
                <p class="text-sm text-text/70">
                  Sin notas en el pedido
                </p>
              }
            </div>

            <!-- Acciones -->
            <div class="flex flex-wrap gap-2 justify-between">
              <!-- Cambiar estado rÃ¡pido -->
               <div class="flex flex-wrap gap-2 ">
              @if (order.status === 'pending') {
                <button 
                  (click)="updateStatus(order._id, 'confirmed')"
                  class="btn-secondary bg-success text-white text-sm px-3 py-1">
                  âœ“ Confirmar
                </button>
              }
              @if (order.status === 'confirmed') {
                <button 
                  (click)="updateStatus(order._id, 'delivered')"
                  class="btn-secondary bg-primary text-white text-sm px-3 py-1">
                  âœ“ Marcar entregado
                </button>
              }
              
              <!-- Editar -->
              <button 
                (click)="openEditModal(order._id)"
                class="btn-secondary bg-accent text-sm px-3 py-1">
                âœï¸ Editar
              </button>
              </div>
              <!-- Eliminar -->
              <button 
                (click)="deleteOrder(order._id, order.customerName)"
                class="btn-secondary bg-error text-white text-sm px-3 py-1">
                ğŸ—‘ï¸
              </button>
            </div>
          </article>
        }
      </div>
    }
  }


  <app-order-form />
</section>